<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Mini-estante com Covers Automáticos (inclui CBR)</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #shelf {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 12px;
    }
    .card img {
      width: 100%;
      height: 180px;
      object-fit: cover;
      border-radius: 4px;
      background: #ddd;
    }
    .caption {
      text-align: center;
      font-size: 12px;
      margin-top: 4px;
      word-break: break-word;
    }
  </style>
</head>
<body>
  <h1>Mini-estante com Covers Automáticos (inclui CBR)</h1>
  <div id="shelf"></div>

  <!-- uncompress.js para ZIP/TAR/RAR(CBR) no browser -->
  <script src="https://unpkg.com/uncompress.js/dist/uncompress.min.js"></script>
  <script>
    const folderId       = "10A__4JOje3uuOc4-ywuwikswsgPiQf4R";
    const apiKey         = "AIzaSyCSfROD8xDz5GvmvcRIt5X1FqIWk2Yb7xc";
    const capaFolderName = "capas";

    function getExtension(name) {
      return name.split('.').pop().toLowerCase();
    }

    // gera um fallback minimalista via canvas
    function generateCoverDataUrl(title, w=120, h=180) {
      const c = document.createElement('canvas');
      c.width = w; c.height = h;
      const ctx = c.getContext('2d');
      ctx.fillStyle = '#ccc';
      ctx.fillRect(0,0,w,h);
      ctx.fillStyle = '#444';
      ctx.font = '12px sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText('Sem capa', w/2, h/2);
      return c.toDataURL();
    }

    // 1) Busca recursiva de arquivos no Drive (inclui webContentLink & thumbnailLink)
    async function listFilesRecursively(parentId, path = "") {
      const url = [
        'https://www.googleapis.com/drive/v3/files',
        `?q='${parentId}'+in+parents+and+trashed=false`,
        `&key=${apiKey}`,
        `&supportsAllDrives=true&includeItemsFromAllDrives=true`,
        `&fields=files(` +
          `id,name,mimeType,webViewLink,webContentLink,thumbnailLink` +
        `)`
      ].join('');
      const res   = await fetch(url);
      const data  = await res.json();
      let results = [];
      for (const file of data.files || []) {
        if (file.mimeType === "application/vnd.google-apps.folder") {
          if (file.name.toLowerCase() !== capaFolderName) {
            const sub = await listFilesRecursively(file.id, path + file.name + "/");
            results = results.concat(sub);
          }
        } else {
          file.path = path;
          results.push(file);
        }
      }
      return results;
    }

    // 2) Extrai a primeira imagem de um .cbr usando uncompress.js
    async function fetchFirstCbrCover(downloadUrl) {
      const res  = await fetch(downloadUrl);
      const blob = await res.blob();
      const entries = await uncompress(blob);
      const imgEntry = entries.find(e => /\.(jpe?g|png|gif)$/i.test(e.filename));
      if (!imgEntry) return null;
      const imageBlob = new Blob([imgEntry.data], { type: 'image/jpeg' });
      return URL.createObjectURL(imageBlob);
    }

    // 3) Renderiza a estante com lazy-load, thumbnail e CBR
    async function renderShelf() {
      const shelf = document.getElementById('shelf');
      const files = await listFilesRecursively(folderId);
      shelf.innerHTML = "";

      for (const file of files) {
        const ext = getExtension(file.name);
        let coverUrl = null;

        if (ext === 'cbr') {
          // sempre usa alt=media da API, via webContentLink
          const downloadUrl = file.webContentLink
            || `https://www.googleapis.com/drive/v3/files/${file.id}?alt=media&key=${apiKey}`;
          try {
            coverUrl = await fetchFirstCbrCover(downloadUrl);
          } catch {
            coverUrl = null;
          }
        }

        // se não extraiu CBR, tenta thumbnail do Drive
        if (!coverUrl) {
          coverUrl = file.thumbnailLink
            // caso não exista thumbnailLink, usa canvas fallback
            || generateCoverDataUrl(file.name);
        }

        const card = document.createElement("div");
        card.className = "card";

        const link = document.createElement("a");
        link.href   = file.webViewLink;
        link.target = "_blank";

        const img = document.createElement("img");
        img.loading = "lazy";
        img.src     = coverUrl;
        img.alt     = file.name;
        link.appendChild(img);

        const caption = document.createElement("div");
        caption.className = "caption";
        caption.textContent = file.name;

        card.appendChild(link);
        card.appendChild(caption);
        shelf.appendChild(card);
      }
    }

    document.addEventListener("DOMContentLoaded", renderShelf);
  </script>
</body>
</html>
